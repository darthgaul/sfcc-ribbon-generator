function generateRibbon() {
    if (!uploadedImage) return;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const colorThief = new ColorThief();
    const palette = colorThief.getPalette(uploadedImage, 5);
    let colors = palette.map(color => `rgb(${color[0]}, ${color[1]}, ${color[2]})`);
    console.log('Original colors:', colors);

    while (colors.length < 5) {
        colors = colors.concat(colors);
    }
    colors = colors.slice(0, 5);
    const shuffledColors = shuffleArray(colors);
    console.log('Shuffled colors:', shuffledColors);

    const totalStripes = 10;
    const halfStripes = totalStripes / 2;
    const ribbonWidth = canvas.width;
    const halfWidth = ribbonWidth / 2;

    const leftWidths = generateRandomWidths(halfStripes, halfWidth);
    const rightWidths = leftWidths.slice().reverse();
    const fullWidths = [...leftWidths, ...rightWidths];

    const leftColors = shuffledColors.slice(0, halfStripes);
    const rightColors = leftColors.slice().reverse();
    const fullColors = [...leftColors, ...rightColors];

    let currentX = 0;
    for (let i = 0; i < fullWidths.length; i++) {
        ctx.fillStyle = fullColors[i];
        ctx.fillRect(currentX, 0, fullWidths[i], canvas.height);
        currentX += fullWidths[i];
    }

    const lineSpacing = canvas.height / 16;
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
    ctx.lineWidth = 1;
    for (let i = 1; i < 16; i++) {
        ctx.beginPath();
        ctx.moveTo(0, i * lineSpacing);
        ctx.lineTo(ribbonWidth, i * lineSpacing);
        ctx.stroke();
    }

    downloadInstructions.style.display = 'block';
    previousRibbons.push(canvas.toDataURL());
    goBackBtn.disabled = previousRibbons.length <= 1;
    downloadBtn.disabled = false;
}
